---
/**
 * Page: Page Search (Pagefind UI embedded)
 * Path: /pagesearch
 */

// Components
import Layout from '../layouts/Layout.astro'
import SidebarContent from '../components/blocks/basic/StickySidebar.astro'
import Hero from '../components/blocks/hero/PageHeader.astro'

// SEO
const SEO = {
  title: 'Search Trips',
  description:
    'Find a mission trip by country, region, date, and type. Filter and search across our upcoming opportunities.'
}

// Page Header
const header = {
  title: 'Find a <strong>Mission Trip</strong>',
  text: 'Filter by Region, Country, Leave Date, and Trip Type.'
}
---

<Layout title={SEO.title} description={SEO.description}>
  <Hero title={header.title} text={header.text} />

  <SidebarContent>
    <!-- Sidebar -->
    <div slot="sidebar" class="space-y-4">
      <h3 class="text-xl font-semibold">Tips</h3>
      <ul class="list-disc list-inside text-sm text-muted-foreground space-y-2">
        <li>Use the filters to narrow by Region, Country, or Trip Type.</li>
        <li>Try a keyword in the search box (e.g. “Kenya” or “Teaching English”).</li>
        <li>Click a result to view full trip details.</li>
      </ul>
    </div>

    <!-- Main content -->
    <div class="basic-text">
      <section class="rounded-2xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 shadow-sm p-4 sm:p-6 md:p-8">
        <!-- Pagefind UI CSS (can be static) -->
        <link rel="stylesheet" href="/search/pagefind-ui.css" />

        <!-- Mount point -->
        <div id="trip-search" class="pagefind-wrapper" tabindex="-1" aria-label="Site search"></div>

        <!-- Dynamically (re)load Pagefind UI script and mount on every return / interaction -->
        <script is:inline>
          (() => {
            const MOUNT_SEL = '#trip-search';
            const SCRIPT_SRC = '/search/pagefind-ui.js';
            const RETRY_MS = 60;
            const MAX_RETRIES = 16;
            let mounting = false;

            const $ = (sel, root = document) => root.querySelector(sel);

            function purgeInertAndClicks() {
              // Unfreeze any elements that may have been left inert by view transitions or the router
              document.querySelectorAll('[inert]').forEach(n => n.removeAttribute('inert'));
              document.documentElement.style.pointerEvents = 'auto';
              document.body.style.pointerEvents = 'auto';
            }

            function ensureClickable(el) {
              if (!el) return;
              el.style.pointerEvents = 'auto';
              let p = el.parentElement;
              while (p) { p.style.pointerEvents = 'auto'; p = p.parentElement; }
            }

            function hasUI(wrapper) {
              return !!wrapper.querySelector('.pagefind-ui__form, .pagefind-ui__search-input');
            }

            function injectScriptFresh(onload) {
              // Remove any previously injected script (so it will execute again)
              document.querySelectorAll('script[data-pagefind-dynamic]').forEach(s => s.remove());

              const s = document.createElement('script');
              s.src = `${SCRIPT_SRC}?v=${Date.now()}`; // bust frozen/bfcache’d exec state
              s.async = true;
              s.defer = true;
              s.dataset.pagefindDynamic = '1';
              s.addEventListener('load', () => onload && onload());
              s.addEventListener('error', () => console.error('Failed to load Pagefind UI script'));
              document.head.appendChild(s);
            }

            function mountPagefind({ force = false, retries = 0 } = {}) {
              const el = $(MOUNT_SEL);
              if (!el) return;

              // If already mounted and not forcing, skip.
              if (!force && hasUI(el)) return;
              if (mounting) return;

              purgeInertAndClicks();
              ensureClickable(el);

              const startMount = () => {
                if (!window.PagefindUI) {
                  if (retries >= MAX_RETRIES) return;
                  return setTimeout(() => mountPagefind({ force, retries: retries + 1 }), RETRY_MS);
                }

                mounting = true;
                // clean slate
                el.innerHTML = '';

                try {
                  new window.PagefindUI({
                    element: MOUNT_SEL,
                    basePath: '/search/',
                    // translations: { placeholder: 'Search trips…' }
                  });
                } catch (e) {
                  console.error('Pagefind init failed:', e);
                } finally {
                  mounting = false;
                  // Make absolutely sure input is interactive
                  const input = $('.pagefind-ui__search-input', el);
                  ensureClickable(input || el);
                }
              };

              if (!window.PagefindUI) {
                // Always (re)inject script to guarantee execution after BFCache restore
                injectScriptFresh(startMount);
              } else {
                startMount();
              }
            }

            // Initial mount
            if (document.readyState === 'loading') {
              document.addEventListener('DOMContentLoaded', () => mountPagefind({ force: true }), { once: true });
            } else {
              mountPagefind({ force: true });
            }

            // Astro client router lifecycle
            window.addEventListener('astro:page-load', () => mountPagefind({ force: true }));
            window.addEventListener('astro:after-swap', () => mountPagefind({ force: true }));

            // BFCache restore: no reload; re-inject and mount
            window.addEventListener('pageshow', (e) => {
              if (e.persisted) {
                purgeInertAndClicks();
                mountPagefind({ force: true });
              }
            });

            // Visible again? make sure UI is alive
            document.addEventListener('visibilitychange', () => {
              if (document.visibilityState === 'visible') mountPagefind();
            });

            // User interaction “last resort” activators
            const wrapper = $(MOUNT_SEL);
            if (wrapper) {
              const trigger = () => mountPagefind({ force: false });
              wrapper.addEventListener('pointerdown', trigger, { passive: true });
              wrapper.addEventListener('focus', trigger, { capture: true, passive: true });
              wrapper.addEventListener('keydown', trigger, { capture: true });
            }
          })();
        </script>
      </section>
    </div>
  </SidebarContent>
</Layout>

<style is:global>
  /* Dark-mode readability */
  html.dark .pagefind-wrapper,
  @media (prefers-color-scheme: dark) {
    html:not(.dark) .pagefind-wrapper { /* noop */ }
  }

  html.dark .pagefind-wrapper .pagefind-ui__form,
  html.dark .pagefind-wrapper .pagefind-ui__drawer,
  html.dark .pagefind-wrapper .pagefind-ui__results-area {
    background: transparent;
    color: #e5e7eb;
    border-color: rgba(255,255,255,0.12);
  }

  html.dark .pagefind-wrapper .pagefind-ui__search-input {
    background: rgba(255,255,255,0.06);
    color: #e5e7eb;
    border: 1px solid rgba(255,255,255,0.12);
    caret-color: #bfdbfe;
  }
  html.dark .pagefind-wrapper .pagefind-ui__search-input::placeholder {
    color: rgba(229,231,235,0.85) !important;
  }

  html.dark .pagefind-wrapper .pagefind-ui__label,
  html.dark .pagefind-wrapper label[for^="pagefind-"],
  html.dark .pagefind-wrapper .pagefind-ui__search-icon {
    color: #e5e7eb !important;
    fill: currentColor !important;
    stroke: currentColor !important;
    opacity: 0.95;
  }

  html.dark .pagefind-wrapper .pagefind-ui__button,
  html.dark .pagefind-wrapper .pagefind-ui__filter-pill,
  html.dark .pagefind-wrapper .pagefind-ui__filter-link {
    background: rgba(255,255,255,0.06);
    color: #e5e7eb;
    border: 1px solid rgba(255,255,255,0.12);
  }

  /* Result titles */
  html.dark .pagefind-wrapper {
    --pf-title: #e5e7eb;
    --pf-title-hover: #bfdbfe;
  }
  html.dark .pagefind-wrapper .pagefind-ui__result-title,
  html.dark .pagefind-wrapper .pagefind-ui__result-title *,
  html.dark .pagefind-wrapper .pagefind-ui__result-link {
    color: var(--pf-title) !important;
  }
  html.dark .pagefind-wrapper .pagefind-ui__result-title a:is(:link,:visited,:active) {
    color: var(--pf-title) !important;
    text-decoration: none;
  }
  html.dark .pagefind-wrapper .pagefind-ui__result-title a:is(:hover,:focus-visible),
  html.dark .pagefind-wrapper .pagefind-ui__result-link:is(:hover,:focus-visible) {
    color: var(--pf-title-hover) !important;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  html.dark .pagefind-wrapper .pagefind-ui__result-excerpt,
  html.dark .pagefind-wrapper .pagefind-ui__message {
    color: #e5e7eb;
  }
  html.dark .pagefind-wrapper .pagefind-ui__result {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.10);
  }

  html.dark .pagefind-wrapper .pagefind-ui__filter-group-title,
  html.dark .pagefind-wrapper .pagefind-ui__filter-count {
    color: #cbd5e1;
  }

  html.dark .pagefind-wrapper .pagefind-ui__result-excerpt mark {
    background: rgba(250,204,21,0.25);
    color: inherit;
    border-radius: 0.25rem;
    padding: 0 .1rem;
  }

  /* Hide the clear (reset) button */
  .pagefind-wrapper .pagefind-ui__reset { display: none !important; }

  /* Defensive: always allow clicks */
  .pagefind-wrapper, .pagefind-wrapper * { pointer-events: auto; }
</style>