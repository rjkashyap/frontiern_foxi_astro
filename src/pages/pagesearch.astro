---
/**
 * Page: Page Search (Pagefind UI embedded)
 * Path: /pagesearch
 */

// Components
import Layout from '../layouts/Layout.astro'
import SidebarContent from '../components/blocks/basic/StickySidebar.astro'
import Hero from '../components/blocks/hero/PageHeader.astro'

// Types for our demo data
type Trip = {
  code?: string
  title: string
  region: string
  country: string
  leave_date?: string
  end_date?: string
  trip_type: string
  access_activities?: string[]
  blurb?: string
  image?: string
  url?: string
}

// Build-time load of JSON without requiring TS "resolveJsonModule"
const trips: Trip[] = await (await fetch(
  new URL('../../data/json-files/trips.json', import.meta.url)
)).json()

// Helpers to derive date facets
const getYear = (d?: string) => (d ? String(new Date(d).getUTCFullYear()) : '')
const getMonth = (d?: string) =>
  d ? String(new Date(d).getUTCMonth() + 1).padStart(2, '0') : ''

// SEO
const SEO = {
  title: 'Search Trips',
  description:
    'Find a mission trip by country, region, date, and type. Filter and search across our upcoming opportunities.'
}

// Page Header
const header = {
  title: 'Find a <strong>Mission Trip</strong>',
  text: 'Filter by Region, Country, Leave Date (Year/Month), and Trip Type.'
}
---

<Layout title={SEO.title} description={SEO.description}>
  <Hero title={header.title} text={header.text} />

  <SidebarContent>
    <!-- Sidebar -->
    <div slot="sidebar" class="space-y-4">
      <h3 class="text-xl font-semibold">Tips</h3>
      <ul class="list-disc list-inside text-sm text-muted-foreground space-y-2">
        <li>Use the filters to narrow by Region, Country, Trip Type, or Year/Month.</li>
        <li>Try a keyword in the search box (e.g. “Kenya” or “Teaching English”).</li>
        <li>Click a result to view full trip details.</li>
      </ul>
    </div>

    <!-- Main content -->
    <div class="basic-text">
      <!-- Container that matches your site’s spacing / cards -->
      <section class="rounded-2xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 shadow-sm p-4 sm:p-6 md:p-8">
        <!-- Pagefind UI assets -->
        <link rel="stylesheet" href="/search/pagefind-ui.css" />
        <!-- keep this as a raw external script (don’t let Vite bundle it) -->
        <script src="/search/pagefind-ui.js" is:inline></script>

        <!-- Mount point -->
        <div id="trip-search" class="pagefind-wrapper"></div>

        <!-- Initialise Pagefind UI -->
        <script is:inline>
          // PagefindUI is loaded by the external script above
          if (typeof window !== "undefined" && window.PagefindUI) {
            new window.PagefindUI({
              element: "#trip-search",
              basePath: "/search/"
              // You can add: translations: { placeholder: "Search trips..." }
            });
          }
        </script>
      </section>

      <!-- Phase 1 demo: render your trips so Pagefind can detect facets -->
      <section class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 mt-8">
        {trips.map((t: Trip) => (
          <article class="rounded-xl border border-gray-200/70 dark:border-white/10 bg-white/70 dark:bg-white/5 p-4 shadow-sm">
            <a href={t.url} class="block">
              {t.image && <img src={t.image} alt={t.title} class="w-full h-40 object-cover rounded-lg mb-3" />}
              <h3 class="text-lg font-semibold">{t.title}</h3>
              {t.blurb && <p class="text-sm opacity-80 mt-1">{t.blurb}</p>}
              <p class="text-xs mt-2 opacity-70">
                <span>{t.region}</span> &middot; <span>{t.country}</span> &middot; <span>{t.trip_type}</span>
                {t.leave_date && (
                  <>
                    {' '}• <span>{new Date(t.leave_date).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: '2-digit' })}</span>
                  </>
                )}
              </p>
            </a>

            <!-- Pagefind facets (hidden if you don’t want them visible) -->
            <span data-pagefind-filter="region" class="hidden">{t.region}</span>
            <span data-pagefind-filter="country" class="hidden">{t.country}</span>
            <span data-pagefind-filter="trip_type" class="hidden">{t.trip_type}</span>

            <!-- Date facets (Year/Month) -->
            {t.leave_date && <span data-pagefind-filter="leave_year" class="hidden">{getYear(t.leave_date)}</span>}
            {t.leave_date && <span data-pagefind-filter="leave_month" class="hidden">{getMonth(t.leave_date)}</span>}

            <!-- Optional metadata (sortable later if needed) -->
            {t.leave_date && <span data-pagefind-meta="leave_date" class="hidden">{t.leave_date}</span>}
          </article>
        ))}
      </section>
    </div>
  </SidebarContent>
</Layout>

<style is:global>
  /* Light touch layout polish */
  .pagefind-wrapper .pagefind-ui__form { margin-bottom: 1rem; }
  .pagefind-wrapper .pagefind-ui__search-input {
    border-radius: 0.75rem; padding: 0.75rem 1rem; line-height: 1.25rem;
  }
  .pagefind-wrapper .pagefind-ui__drawer { border-radius: 1rem; }
  .pagefind-wrapper .pagefind-ui__result { border-radius: 0.75rem; }

  /* Dark-mode overrides: containers and text */
  html.dark .pagefind-wrapper .pagefind-ui__form,
  html.dark .pagefind-wrapper .pagefind-ui__drawer,
  html.dark .pagefind-wrapper .pagefind-ui__results-area {
    background: transparent;
    color: #e5e7eb; /* zinc-200 */
    border-color: rgba(255,255,255,0.12);
  }

  html.dark .pagefind-wrapper .pagefind-ui__search-input {
    background: rgba(255,255,255,0.06);
    color: #e5e7eb;
    border: 1px solid rgba(255,255,255,0.12);
  }
  html.dark .pagefind-wrapper .pagefind-ui__search-input::placeholder {
    color: rgba(229,231,235,0.55);
  }

  html.dark .pagefind-wrapper .pagefind-ui__button,
  html.dark .pagefind-wrapper .pagefind-ui__filter-pill,
  html.dark .pagefind-wrapper .pagefind-ui__filter-link {
    background: rgba(255,255,255,0.06);
    color: #e5e7eb;
    border: 1px solid rgba(255,255,255,0.12);
  }

  html.dark .pagefind-wrapper .pagefind-ui__result {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.10);
  }

  /* Make result headings “light up” in dark mode */
  :root {
    --fn-link-dark: #e5e7eb;        /* zinc-200 */
    --fn-link-dark-hover: #bfdbfe;  /* sky-200 */
  }
  html.dark .pagefind-wrapper .pagefind-ui__result-title,
  html.dark .pagefind-wrapper .pagefind-ui__result-title a,
  html.dark .pagefind-wrapper .pagefind-ui__result-link,
  html.dark .pagefind-wrapper .pagefind-ui__result h1,
  html.dark .pagefind-wrapper .pagefind-ui__result h2,
  html.dark .pagefind-wrapper .pagefind-ui__result h3,
  html.dark .pagefind-wrapper .pagefind-ui__result h4 {
    color: var(--fn-link-dark) !important;
  }
  html.dark .pagefind-wrapper .pagefind-ui__result-title a:hover,
  html.dark .pagefind-wrapper .pagefind-ui__result-link:hover,
  html.dark .pagefind-wrapper .pagefind-ui__result-title a:focus-visible,
  html.dark .pagefind-wrapper .pagefind-ui__result-link:focus-visible {
    color: var(--fn-link-dark-hover) !important;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* Other result text */
  html.dark .pagefind-wrapper .pagefind-ui__result-excerpt,
  html.dark .pagefind-wrapper .pagefind-ui__message {
    color: #e5e7eb;
  }

  /* Facet headers & counts */
  html.dark .pagefind-wrapper .pagefind-ui__filter-group-title,
  html.dark .pagefind-wrapper .pagefind-ui__filter-count {
    color: #cbd5e1; /* slate-300 */
  }

  /* Highlighted terms */
  html.dark .pagefind-wrapper .pagefind-ui__result-excerpt mark {
    background: rgba(250,204,21,0.25);  /* amber-400 @ 25% */
    color: inherit;
    border-radius: 0.25rem;
    padding: 0 .1rem;
  }
</style>