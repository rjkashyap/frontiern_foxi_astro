---
/**
 * Page: Trips Filter (no search box)
 * Path: /pagesearch
 */

import Layout from '../layouts/Layout.astro'
import SidebarContent from '../components/blocks/basic/StickySidebar.astro'
import Hero from '../components/blocks/hero/PageHeader.astro'

// SEO
const SEO = {
  title: 'Browse Trips',
  description:
    'All trips are listed below. Use the filters to narrow by Region, Country, and Trip Type.'
}

// Page Header
const header = {
  title: 'All <strong>Mission Trips</strong>',
  text: 'Use the filters to narrow by Region, Country, and Trip Type.'
}
---

<Layout title={SEO.title} description={SEO.description}>
  <Hero title={header.title} text={header.text} />

  <SidebarContent>
    <!-- Sidebar -->
    <div slot="sidebar" class="space-y-4">
      <h3 class="text-xl font-semibold">Filter trips</h3>
      <p class="text-sm text-muted-foreground">
        All trips are visible by default. Select any combination of filters.
      </p>

      <!-- Filter UI is injected here -->
      <div id="trip-filters" class="space-y-6">
        <div class="rounded-xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 p-3">
          <h4 class="font-semibold mb-2">Region</h4>
          <div id="filter-region" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="rounded-xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 p-3">
          <h4 class="font-semibold mb-2">Country</h4>
          <div id="filter-country" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="rounded-xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 p-3">
          <h4 class="font-semibold mb-2">Trip Type</h4>
          <div id="filter-type" class="flex flex-wrap gap-2"></div>
        </div>

        <button id="clear-filters" class="w-full inline-flex items-center justify-center rounded-lg border border-gray-300/70 dark:border-white/15 bg-white/70 dark:bg-white/10 px-3 py-2 text-sm font-medium hover:bg-white dark:hover:bg-white/15 transition">
          Clear all filters
        </button>
      </div>
    </div>

    <!-- Main content -->
    <div class="basic-text">
      <section class="rounded-2xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 shadow-sm p-4 sm:p-6 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Trips</h3>
          <div id="trip-count" class="text-sm text-muted-foreground">Loadingâ€¦</div>
        </div>

        <!-- Cards are injected here -->
        <div id="trip-list" class="grid gap-6 sm:grid-cols-2 xl:grid-cols-3"></div>

        <!-- Optional: lightweight no-results -->
        <p id="no-results" class="hidden mt-6 text-sm text-muted-foreground">No trips match the selected filters.</p>
      </section>
    </div>
  </SidebarContent>
</Layout>

<!-- Client code -->
<script is:inline>
  (() => {
    const ENDPOINTS = ['/trips/index.html', '/trips/', '/trips']; // try these in order
    const LIST_SEL = '#trip-list';
    const COUNT_SEL = '#trip-count';
    const NORES_SEL = '#no-results';

    const FILTER_MAP = [
      { key: 'Region',  container: '#filter-region'  },
      { key: 'Country', container: '#filter-country' },
      { key: 'TripType', container: '#filter-type'  },
    ];

    const state = {
      cards: [],          // Array<HTMLElement>
      facets: new Map(),  // key -> Set(values)
      active: { Region: new Set(), Country: new Set(), TripType: new Set() },
    };

    // --- fetch and mount all cards from /trips page ---
    async function fetchTripsHTML() {
      for (const url of ENDPOINTS) {
        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          if (res.ok) return await res.text();
        } catch (_) { /* try next */ }
      }
      throw new Error('Unable to fetch /trips HTML');
    }

    function extractCards(html) {
      const dom = new DOMParser().parseFromString(html, 'text/html');
      // Try to use the scoped body first (your trips page uses data-pagefind-body)
      const scope = dom.querySelector('[data-pagefind-body]') || dom;
      // Treat each article as a card
      const articles = [...scope.querySelectorAll('article')];
      return articles;
    }

    function readFacetSpans(cardEl) {
      // Example hidden spans:
      // <span data-pagefind-filter="Region" style="display:none">Pacific</span>
      const spans = cardEl.querySelectorAll('[data-pagefind-filter]');
      const bag = {};
      spans.forEach((s) => {
        const k = s.getAttribute('data-pagefind-filter') || '';
        const v = (s.textContent || '').trim();
        if (!k || !v) return;
        if (!bag[k]) bag[k] = [];
        bag[k].push(v);
      });
      return bag;
    }

    function addDataAttributes(cardEl, bag) {
      // store canonical datasets for quick filtering
      if (bag.Region)  cardEl.dataset.region   = bag.Region.join('|');
      if (bag.Country) cardEl.dataset.country  = bag.Country.join('|');
      if (bag.TripType)cardEl.dataset.triptype = bag.TripType.join('|');
    }

    function collectFacetValues(bag) {
      for (const [k, vals] of Object.entries(bag)) {
        if (!state.facets.has(k)) state.facets.set(k, new Set());
        const set = state.facets.get(k);
        vals.forEach((v) => set.add(v));
      }
    }

    function renderCards(cards) {
      const list = document.querySelector(LIST_SEL);
      list.innerHTML = '';
      cards.forEach((el) => list.appendChild(el));
      updateCounts();
    }

    function makePill(label, groupKey) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = label;
      btn.className =
        'px-2.5 py-1.5 text-xs rounded-full border border-gray-300/70 dark:border-white/15 bg-white/70 dark:bg-white/10 hover:bg-white dark:hover:bg-white/15 transition';
      btn.setAttribute('data-value', label);
      btn.addEventListener('click', () => {
        toggleFacet(groupKey, label);
        btn.classList.toggle('ring-2');
        btn.classList.toggle('ring-sky-300/70');
        btn.classList.toggle('dark:ring-sky-300/40');
        applyFilters();
      });
      return btn;
    }

    function renderFilters() {
      FILTER_MAP.forEach(({ key, container }) => {
        const holder = document.querySelector(container);
        holder.innerHTML = '';
        const values = [...(state.facets.get(key) || [])].sort((a, b) => a.localeCompare(b));
        values.forEach((val) => holder.appendChild(makePill(val, key)));
      });

      // Clear button
      const clearBtn = document.getElementById('clear-filters');
      clearBtn.addEventListener('click', () => {
        state.active.Region.clear();
        state.active.Country.clear();
        state.active.TripType.clear();
        // Remove visual rings
        document.querySelectorAll('#trip-filters button[data-value]').forEach((b) => {
          b.classList.remove('ring-2', 'ring-sky-300/70', 'dark:ring-sky-300/40');
        });
        applyFilters();
      });
    }

    function toggleFacet(key, value) {
      const set = state.active[key];
      if (set.has(value)) set.delete(value);
      else set.add(value);
    }

    function cardMatchesActive(card) {
      // AND across groups, OR within each group
      const tests = [
        { key: 'Region',   attr: 'region'   },
        { key: 'Country',  attr: 'country'  },
        { key: 'TripType', attr: 'triptype' },
      ];
      for (const { key, attr } of tests) {
        const selected = state.active[key];
        if (selected.size === 0) continue; // group not restricting
        const values = (card.dataset[attr] || '').split('|').filter(Boolean);
        // match if card has ANY of the selected values for this group
        const ok = values.some((v) => selected.has(v));
        if (!ok) return false;
      }
      return true;
    }

    function applyFilters() {
      let shown = 0;
      state.cards.forEach((card) => {
        const visible = cardMatchesActive(card);
        card.style.display = visible ? '' : 'none';
        if (visible) shown++;
      });
      updateCounts(shown);
    }

    function updateCounts(overrideShown) {
      const total = state.cards.length;
      const shown = overrideShown ?? state.cards.filter((c) => c.style.display !== 'none').length;
      const el = document.querySelector(COUNT_SEL);
      if (el) el.textContent = `${shown} of ${total} trips`;
      const nr = document.querySelector(NORES_SEL);
      if (nr) nr.classList.toggle('hidden', shown > 0);
    }

    async function init() {
      try {
        const html = await fetchTripsHTML();
        const cards = extractCards(html).map((card) => {
          // Ensure links remain same-origin relative
          card.querySelectorAll('a[href^="/"]').forEach((a) => a.setAttribute('rel', 'nofollow'));
          const bag = readFacetSpans(card);
          addDataAttributes(card, bag);
          collectFacetValues(bag);
          // Make each card visually consistent in this grid
          card.classList.add(
            'rounded-xl','border','border-gray-200/70','dark:border-white/10','bg-white','dark:bg-white/5','p-4','h-full'
          );
          // Ensure titles remain bright in dark mode
          card.querySelectorAll('h2,h3 a, h2 a, h3').forEach((n) => n.classList.add('text-gray-900','dark:text-zinc-100'));
          // Prefer pointer cursor
          card.querySelectorAll('a').forEach((a) => a.classList.add('cursor-pointer'));
          return card;
        });

        state.cards = cards;
        renderFilters();
        renderCards(cards);    // show all on load
        applyFilters();        // immediately compute counts (no filtering yet)
      } catch (e) {
        console.error('Trips filter init failed:', e);
        const list = document.querySelector(LIST_SEL);
        if (list) list.innerHTML = '<p class="text-sm text-red-600 dark:text-red-400">Failed to load trips.</p>';
      }
    }

    // Run on initial load, on Astro client route swaps, and on BFCache restore
    const start = () => init();
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', start, { once: true });
    } else {
      start();
    }
    window.addEventListener('astro:page-load', start);
    window.addEventListener('astro:after-swap', start);
    window.addEventListener('pageshow', (e) => { if (e.persisted) start(); });
  })();
</script>

<style is:global>
  /* Dark mode notes:
     - Cards and text are already styled with light/dark classes in JS above.
     - Keep any additional overrides here if you want to tweak further. */

  /* Filter pills accessibility focus */
  #trip-filters button[data-value]:focus-visible {
    outline: 2px solid rgba(56, 189, 248, 0.65); /* sky-400-ish */
    outline-offset: 2px;
  }
</style>