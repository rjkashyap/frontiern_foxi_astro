---
/**
 * Page: Trips Filter (no search box)
 * Path: /opportunities
 */

import Layout from '../layouts/Layout.astro'
import SidebarContent from '../components/blocks/basic/StickySidebar.astro'
import Hero from '../components/blocks/hero/PageHeader.astro'

// SEO
const SEO = {
  title: 'Browse Trips',
  description:
    'All trips are listed below. Use the filters to narrow by Region, Country, and Trip Type.'
}

// Page Header
const header = {
  title: 'All <strong>Mission Trips</strong>',
  text: 'Use the filters to narrow by Region, Country, and Trip Type.'
}
---

<Layout title={SEO.title} description={SEO.description}>
  <Hero title={header.title} text={header.text} />

  <SidebarContent>
    <!-- Sidebar -->
    <div slot="sidebar" class="space-y-4">
      <h3 class="text-xl font-semibold">Filter trips</h3>
      <p class="text-sm text-muted-foreground">
        All trips are visible by default. Select any combination of filters.
      </p>

      <!-- Filter UI is injected here -->
      <div id="trip-filters" class="space-y-6">
        <div class="rounded-xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 p-3">
          <h4 class="font-semibold mb-2">Region</h4>
          <div id="filter-region" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="rounded-xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 p-3">
          <h4 class="font-semibold mb-2">Country</h4>
          <div id="filter-country" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="rounded-xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 p-3">
          <h4 class="font-semibold mb-2">Trip Type</h4>
          <div id="filter-type" class="flex flex-wrap gap-2"></div>
        </div>

        <button id="clear-filters" class="w-full inline-flex items-center justify-center rounded-lg border border-gray-300/70 dark:border-white/15 bg-white/70 dark:bg-white/10 px-3 py-2 text-sm font-medium hover:bg-white dark:hover:bg-white/15 transition">
          Clear all filters
        </button>
      </div>
    </div>

    <!-- Main content -->
    <div class="basic-text">
      <section class="rounded-2xl border border-gray-200/70 dark:border-white/10 bg-white/60 dark:bg-white/5 shadow-sm p-4 sm:p-6 md:p-8">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold">Trips</h3>
          <div id="trip-count" class="text-sm text-muted-foreground">Loading…</div>
        </div>

        <!-- Cards are injected here -->
        <div id="trip-list" class="grid gap-6 sm:grid-cols-2 xl:grid-cols-3"></div>

        <!-- Optional: lightweight no-results -->
        <p id="no-results" class="hidden mt-6 text-sm text-muted-foreground">No trips match the selected filters.</p>
      </section>
    </div>
  </SidebarContent>
</Layout>

<!-- Client code (pure JavaScript, no TS) -->
<script is:inline>
  (() => {
    const ENDPOINTS = ['/trips/index.html', '/trips/', '/trips']; // try these in order
    const LIST_SEL = '#trip-list';
    const COUNT_SEL = '#trip-count';
    const NORES_SEL = '#no-results';

    const FILTER_MAP = [
      { key: 'Region',  container: '#filter-region'  },
      { key: 'Country', container: '#filter-country' },
      { key: 'TripType', container: '#filter-type'  },
    ];

    const state = {
      cards: [],          // Array<HTMLElement> (final FeatureCard DOM nodes)
      facets: new Map(),  // key -> Set(values)
      active: { Region: new Set(), Country: new Set(), TripType: new Set() },
    };

    // ---------- Fetch & extract ----------
    async function fetchTripsHTML() {
      for (const url of ENDPOINTS) {
        try {
          const res = await fetch(url, { credentials: 'same-origin' });
          if (res.ok) return await res.text();
        } catch (_) { /* try next */ }
      }
      throw new Error('Unable to fetch /trips HTML');
    }

    function extractArticles(html) {
      const dom = new DOMParser().parseFromString(html, 'text/html');
      const scope = dom.querySelector('[data-pagefind-body]') || dom;
      return Array.from(scope.querySelectorAll('article'));
    }

    // ---------- Data helpers ----------
    function readFacetSpans(cardEl) {
      const spans = cardEl.querySelectorAll('[data-pagefind-filter]');
      const bag = {};
      spans.forEach((s) => {
        const k = s.getAttribute('data-pagefind-filter') || '';
        const v = (s.textContent || '').trim();
        if (!k || !v) return;
        (bag[k] ||= []).push(v);
      });
      return bag;
    }

    function collectFacetValues(bag) {
      for (const [k, vals] of Object.entries(bag)) {
        if (!state.facets.has(k)) state.facets.set(k, new Set());
        const set = state.facets.get(k);
        vals.forEach((v) => set.add(v));
      }
    }

    function escapeHTML(s) {
      return String(s).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function articleToData(article) {
      const titleEl = article.querySelector('h2,h3');
      const linkEl  = (titleEl && titleEl.querySelector('a')) || article.querySelector('a[href]');
      const descEl  = article.querySelector('p');

      // Prefer first usable <img> inside the article; fallback to a 1×1 transparent gif
      const imgEl = article.querySelector('img');
      const imgSrc = (imgEl && imgEl.getAttribute('src')) || 'data:image/gif;base64,R0lGODlhAQABAAAAACw=';

      const bag = readFacetSpans(article);

      return {
        title: (titleEl && titleEl.textContent || 'Untitled Trip').trim(),
        href:  (linkEl && linkEl.getAttribute('href')) || '#',
        subtitle: (descEl && descEl.textContent || '').trim(),
        image: imgSrc,
        bag
      };
    }

    // ---------- Build FeatureCard DOM (no overlay, whole card has a link + visible CTA) ----------
    function buildFeatureCard(data) {
      const title = data.title;
      const subtitle = data.subtitle;
      const image = data.image;
      const href = data.href;
      const bag = data.bag || {};

      const wrap = document.createElement('div');
      wrap.className = 'card-wrap relative h-full w-full';

      // dataset for filtering
      if (bag.Region)   wrap.dataset.region   = bag.Region.join('|');
      if (bag.Country)  wrap.dataset.country  = bag.Country.join('|');
      if (bag.TripType) wrap.dataset.triptype = bag.TripType.join('|');

      wrap.innerHTML = `
        <div class="flex h-full w-full">
          <div class="flex flex-col h-full w-full">
            <div class="w-full h-full flex flex-col justify-between rounded-xl border border-neutral-100 dark:border-neutral-800 bg-neutral-50 dark:bg-neutral-900 overflow-hidden shadow-none">
              <!-- CONTENT -->
              <a href="${href}" class="block p-4">
                <h3 class="text-base font-semibold text-gray-900 dark:text-zinc-100 hover:underline">
                  ${escapeHTML(title)}
                </h3>
                ${subtitle ? `<p class="mt-1 text-sm text-neutral-600 dark:text-neutral-300">${escapeHTML(subtitle)}</p>` : ''}
              </a>

              <!-- image-bottom -->
              <a href="${href}" class="block mt-auto">
                <div class="aspect-[16/9] w-full bg-neutral-200/60 dark:bg-neutral-800/60 flex items-center justify-center">
                  <img src="${image}" alt="" class="h-16 opacity-90" loading="lazy" />
                </div>
              </a>

              <!-- Visible CTA -->
              <div class="mt-1 mb-3 flex justify-center relative z-10">
                <a href="${href}" class="inline-flex items-center rounded-md px-3 py-1.5 text-sm font-medium bg-sky-600 text-white hover:bg-sky-700 transition">
                  Learn more
                </a>
              </div>
            </div>
          </div>
        </div>
      `;

      return wrap;
    }

    // ---------- UI render ----------
    function renderCards(cards) {
      const list = document.querySelector(LIST_SEL);
      list.innerHTML = '';
      cards.forEach((el) => list.appendChild(el));
      updateCounts();
    }

    function makePill(label, groupKey) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = label;
      btn.className =
        'px-2.5 py-1.5 text-xs rounded-full border border-gray-300/70 dark:border-white/15 bg-white/70 dark:bg-white/10 hover:bg-white dark:hover:bg-white/15 transition';
      btn.setAttribute('data-value', label);
      btn.addEventListener('click', () => {
        toggleFacet(groupKey, label);
        btn.classList.toggle('ring-2');
        btn.classList.toggle('ring-sky-300/70');
        btn.classList.toggle('dark:ring-sky-300/40');
        applyFilters();
      });
      return btn;
    }

    function renderFilters() {
      FILTER_MAP.forEach(({ key, container }) => {
        const holder = document.querySelector(container);
        holder.innerHTML = '';
        const values = Array.from(state.facets.get(key) || []).sort((a, b) => a.localeCompare(b));
        values.forEach((val) => holder.appendChild(makePill(val, key)));
      });

      const clearBtn = document.getElementById('clear-filters');
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          state.active.Region.clear();
          state.active.Country.clear();
          state.active.TripType.clear();
          document.querySelectorAll('#trip-filters button[data-value]').forEach((b) => {
            b.classList.remove('ring-2', 'ring-sky-300/70', 'dark:ring-sky-300/40');
          });
          applyFilters();
        });
      }
    }

    // ---------- Filtering ----------
    function toggleFacet(key, value) {
      const set = state.active[key];
      if (set.has(value)) set.delete(value);
      else set.add(value);
    }

    function cardMatchesActive(card) {
      const tests = [
        { key: 'Region',   attr: 'region'   },
        { key: 'Country',  attr: 'country'  },
        { key: 'TripType', attr: 'triptype' },
      ];
      for (const t of tests) {
        const selected = state.active[t.key];
        if (selected.size === 0) continue;
        const values = (card.dataset[t.attr] || '').split('|').filter(Boolean);
        if (!values.some((v) => selected.has(v))) return false;
      }
      return true;
    }

    function applyFilters() {
      let shown = 0;
      state.cards.forEach((card) => {
        const visible = cardMatchesActive(card);
        card.style.display = visible ? '' : 'none';
        if (visible) shown++;
      });
      updateCounts(shown);
    }

    function updateCounts(overrideShown) {
      const total = state.cards.length;
      const shown = overrideShown != null
        ? overrideShown
        : state.cards.filter((c) => c.style.display !== 'none').length;

      const el = document.querySelector(COUNT_SEL);
      if (el) el.textContent = `${shown} of ${total} trips`;

      const nr = document.querySelector(NORES_SEL);
      if (nr) nr.classList.toggle('hidden', shown > 0);
    }

    // ---------- Boot ----------
    async function init() {
      try {
        const html = await fetchTripsHTML();
        const articles = extractArticles(html);

        // Build FeatureCard DOM from each article
        const cards = articles.map((article) => {
          const data = articleToData(article);
          collectFacetValues(data.bag);
          return buildFeatureCard(data);
        });

        state.cards = cards;
        renderFilters();
        renderCards(cards); // show all on load
        applyFilters();     // update counts
      } catch (e) {
        console.error('Trips filter init failed:', e);
        const list = document.querySelector(LIST_SEL);
        if (list) list.innerHTML = '<p class="text-sm text-red-600 dark:text-red-400">Failed to load trips.</p>';
      }
    }

    const start = () => init();
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', start, { once: true });
    } else {
      start();
    }
    window.addEventListener('astro:page-load', start);
    window.addEventListener('astro:after-swap', start);
    window.addEventListener('pageshow', (e) => { if (e.persisted) start(); });
  })();
</script>

<style is:global>
  /* Filter pills accessibility focus */
  #trip-filters button[data-value]:focus-visible {
    outline: 2px solid rgba(56, 189, 248, 0.65); /* sky-400-ish */
    outline-offset: 2px;
  }
</style>